// prisma/schema.prisma - Enhanced with payment integrations and detailed app info

generator client {
  provider = "prisma-client"
  output   = "../prisma/generated"
 
}

datasource db {
  provider = "postgresql"
}


model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  name          String
  company       String?
  role          UserRole  @default(DEVELOPER)
  emailVerified Boolean   @default(false)
  verifyToken   String?   @unique
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  developer     Developer?
  reviewer      Reviewer?
  purchases     Purchase[]
  transactions  Transaction[]
}

model Developer {
  id                      String    @id @default(cuid())
  userId                  String    @unique
  user                    User      @relation(fields: [userId], references: [id])
  organizationName        String
  websiteUrl              String?
  phone                   String?
  address                 String?
  taxId                   String?
  isVerified              Boolean   @default(false)
  verificationDocs        Json?
  
  // Profile & Settings
  bio                     String?
  logoUrl                 String?
  socialLinks             Json?     @default("{}") // { discord, twitter, youtube }
  preferences             Json?     @default("{}") // { timezone, notifications, twoFactor }
  
  // Payment Integration Fields
  payoutMethod            PayoutMethod?
  payoutCurrency          String    @default("USD")
  
  // Flutterwave Integration
  flutterwaveSubaccountId String?
  flutterwaveBankCode     String?
  flutterwaveBankAccount  String?
  flutterwaveBankName     String?
  
  // Stripe Connect Integration
  stripeConnectAccountId  String?
  stripeAccountStatus     String?   // 'pending', 'active', 'restricted'
  stripePayoutsEnabled    Boolean   @default(false)
  stripeChargesEnabled    Boolean   @default(false)
  
  // M-Pesa / Mobile Money
  mpesaPhoneNumber        String?
  mobileMoneyNetwork      String?   // 'MPESA', 'MTN', 'AIRTEL', etc.
  
  createdAt               DateTime  @default(now())
  updatedAt               DateTime  @updatedAt
  
  apps                    App[]
  payouts                 Payout[]
  earnings                DeveloperEarning[]
}

model Reviewer {
  id         String      @id @default(cuid())
  userId     String      @unique
  user       User        @relation(fields: [userId], references: [id])
  department String
  level      Int         @default(1)
  createdAt  DateTime    @default(now())
  
  reviews    AppReview[]
  submissions Submission[]
}

model App {
  id              String      @id @default(cuid())
  slug            String      @unique
  name            String
  developerId     String
  developer       Developer   @relation(fields: [developerId], references: [id])
  
  // Basic Info
  version         String
  summary         String      // Short description (max 80 chars)
  description     String      // Full description with markdown support
  
  // Categorization
  category        Category
  subcategory     String?
  tags            Json        @default("[]") // Array of tags
  contentRating   ContentRating @default(EVERYONE)
  
  // Pricing
  price           Float       @default(0)
  currency        String      @default("USD")
  salePrice       Float?
  saleEndDate     DateTime?
  
  // Media Assets
  apkUrl          String?
  iconUrl         String?
  screenshots     Json        // Array of screenshot URLs
  heroImageUrl    String?
  trailerUrl      String?
  trailerVideoUrl String?     // Uploaded video file URL
  promoVideoUrl   String?     // Additional promo video
  
  // Technical Details
  sizeBytes       BigInt
  sha256          String?
  minApiLevel     Int         @default(29)
  targetApiLevel  Int?
  targetDevices   Json        // Array of supported devices
  permissions     Json        // Array of required permissions
  
  // Enhanced Details (SideQuest-like)
  features        Json        @default("[]") // Key features list
  whatsNew        String?     // Release notes / changelog
  languages       Json        @default("[]") // Supported languages
  privacyPolicyUrl String?
  supportUrl      String?
  supportEmail    String?
  discordUrl      String?
  twitterUrl      String?
  youtubeUrl      String?
  
  // Hardware Requirements
  requiresHandTracking Boolean @default(false)
  requiresPassthrough  Boolean @default(false)
  requiresControllers  Boolean @default(true)
  comfortLevel    ComfortLevel @default(COMFORTABLE)
  playArea        PlayArea    @default(STANDING)
  playerModes     Json        @default("[\"SINGLE_PLAYER\"]") // Array
  
  // Additional Info
  estimatedPlayTime String?
  ageRating       String?
  containsAds     Boolean     @default(false)
  hasInAppPurchases Boolean   @default(false)
  inAppPurchaseInfo String?
  
  // Developer Notes
  developerNotes  String?
  credits         String?
  acknowledgments String?
  
  // Status & Dates
  status          AppStatus   @default(DRAFT)
  publishedAt     DateTime?
  lastUpdated     DateTime    @updatedAt
  createdAt       DateTime    @default(now())
  
  // Metrics
  rating          Float?
  ratingCount     Int         @default(0)
  downloads       Int         @default(0)
  revenue         Float       @default(0)
  viewCount       Int         @default(0)
  wishlistCount   Int         @default(0)
  
  // Relations
  reviews         AppReview[]
  analytics       Analytics[]
  transactions    Transaction[]
  purchases       Purchase[]
  userReviews     UserReview[]

  // Meta-style Workflow Relations
  draft           AppDraft? 
  channels        ReleaseChannel[]
  submissions     Submission[]
  artifacts       Artifact[]
}

// STAGING: Editable metadata ("WIP" version)
model AppDraft {
  id              String   @id @default(cuid())
  appId           String   @unique
  app             App      @relation(fields: [appId], references: [id])
  
  // Mirrors App metadata fields (nullable for draft state)
  name            String?
  summary         String?     
  description     String?
  category        Category?
  subcategory     String?
  tags            Json?        
  contentRating   ContentRating?
  
  // Pricing
  price           Float?       
  currency        String?
  salePrice       Float?
  saleEndDate     DateTime?
  
  // Media Assets
  iconUrl         String?
  screenshots     Json?
  heroImageUrl    String?
  trailerUrl      String?
  trailerVideoUrl String?
  promoVideoUrl   String?
  
  // Technical Details 
  minApiLevel     Int?
  targetApiLevel  Int?
  targetDevices   Json?
  permissions     Json?
  requiresHandTracking Boolean?
  requiresPassthrough  Boolean?
  requiresControllers  Boolean?
  comfortLevel    ComfortLevel?
  playArea        PlayArea?
  playerModes     Json?
  
  // Additional
  features        Json?
  whatsNew        String?
  languages       Json?
  privacyPolicyUrl String?
  supportUrl      String?
  supportEmail    String?
  discordUrl      String?
  twitterUrl      String?
  youtubeUrl      String?
  estimatedPlayTime String?
  ageRating       String?
  containsAds     Boolean?
  hasInAppPurchases Boolean?
  inAppPurchaseInfo String?
  developerNotes  String?
  credits         String?
  acknowledgments String?

  updatedAt       DateTime @updatedAt
}

// BINARY: Immutable uploaded file
model Artifact {
  id              String   @id @default(cuid())
  appId           String
  app             App      @relation(fields: [appId], references: [id])
  
  versionCode     Int      // e.g., 104
  versionString   String   // "1.0.4"
  fileUrl         String
  fileSize        BigInt
  fileHash        String?  // SHA256
  minApiLevel     Int      @default(29)
  
  // Relations
  releases        Release[] 
  
  createdAt       DateTime @default(now())
}

// CHANNEL: Distribution track (Production, Alpha, Beta)
model ReleaseChannel {
  id          String    @id @default(cuid())
  appId       String
  app         App       @relation(fields: [appId], references: [id])
  key         ReleaseChannelKey // PRODUCTION, ALPHA, BETA, RC

  // The currently active release for this channel
  currentReleaseId String? 
  currentRelease   Release? @relation("ChannelCurrent", fields: [currentReleaseId], references: [id])
  
  releases    Release[] @relation("ChannelReleases")

  @@unique([appId, key])
}

// RELEASE: Deployment of an Artifact to a Channel
model Release {
  id              String @id @default(cuid())
  channelId       String
  channel         ReleaseChannel @relation("ChannelReleases", fields: [channelId], references: [id])
  
  artifactId      String
  artifact        Artifact @relation(fields: [artifactId], references: [id])
  
  // Rollout control
  status          ReleaseStatus @default(ACTIVE)
  rolloutPercentage Int         @default(100)
  
  // Context
  releaseNotes    String?
  deployedAt      DateTime @default(now())
  
  // Reverse relation for "current" - required for One-to-One / One-to-Many setup
  activeForChannels ReleaseChannel[] @relation("ChannelCurrent")
}

// SUBMISSION: Review Request
model Submission {
  id              String   @id @default(cuid())
  appId           String
  app             App      @relation(fields: [appId], references: [id])
  
  // What is being changed?
  targetReleaseId String?  // If set, this release wants to go to Production
  includeDraft    Boolean  @default(false) // If true, apply AppDraft to App on approval
  
  status          SubmissionStatus @default(PENDING)
  
  adminNotes      String?
  submittedAt     DateTime @default(now())
  reviewedAt      DateTime?
  reviewerId      String?
  reviewer        Reviewer? @relation(fields: [reviewerId], references: [id])
}

model AppReview {
  id            String       @id @default(cuid())
  appId         String
  app           App          @relation(fields: [appId], references: [id])
  reviewerId    String
  reviewer      Reviewer     @relation(fields: [reviewerId], references: [id])
  
  status        ReviewStatus
  technicalPass Boolean?
  contentPass   Boolean?
  notes         String?
  vrcResults    Json?
  
  reviewedAt    DateTime     @default(now())
}

// User reviews/ratings for apps
model UserReview {
  id          String   @id @default(cuid())
  appId       String
  app         App      @relation(fields: [appId], references: [id])
  userId      String
  rating      Int      // 1-5
  title       String?
  content     String?
  helpful     Int      @default(0)
  verified    Boolean  @default(false) // Verified purchase
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([appId, userId])
}

model Analytics {
  id          String   @id @default(cuid())
  appId       String
  app         App      @relation(fields: [appId], references: [id])
  date        DateTime
  downloads   Int      @default(0)
  views       Int      @default(0)
  revenue     Float    @default(0)
  sessions    Int      @default(0)
  crashRate   Float    @default(0)
  userRating  Float?
}

model Transaction {
  id                  String            @id @default(cuid())
  appId               String
  app                 App               @relation(fields: [appId], references: [id])
  userId              String
  user                User              @relation(fields: [userId], references: [id])
  
  // Payment Details
  amount              Float
  currency            String            @default("USD")
  platformFee         Float             @default(0)
  developerAmount     Float             @default(0)
  
  // Provider Info
  provider            PaymentProvider
  providerTransactionId String?
  providerSessionId   String?
  paymentMethod       String?           // 'mpesa', 'card', 'bank_transfer'
  
  type                TransactionType
  status              TransactionStatus
  
  // Metadata
  metadata            Json?
  errorMessage        String?
  
  createdAt           DateTime          @default(now())
  completedAt         DateTime?
  refundedAt          DateTime?
}

model Purchase {
  id           String         @id @default(cuid())
  userId       String
  appId        String
  user         User           @relation(fields: [userId], references: [id])
  app          App            @relation(fields: [appId], references: [id])
  
  status       PurchaseStatus
  totalAmount  Decimal
  currency     String         @default("USD")
  
  // Payment tracking
  transactionId String?
  provider      PaymentProvider?
  
  completedAt  DateTime?
  refundedAt   DateTime?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@unique([userId, appId], name: "userId_appId")
}

model Payout {
  id              String       @id @default(cuid())
  developerId     String
  developer       Developer    @relation(fields: [developerId], references: [id])
  
  amount          Float
  currency        String       @default("USD")
  platformFee     Float        @default(0)
  netAmount       Float        // Amount after fees
  
  // Provider Info
  provider        PaymentProvider
  providerTransactionId String?
  
  // Bank/Mobile Money Details (encrypted in production)
  payoutMethod    PayoutMethod
  accountDetails  Json?        // Encrypted bank/mobile money details
  
  status          PayoutStatus
  periodStart     DateTime
  periodEnd       DateTime
  
  errorMessage    String?
  processedAt     DateTime?
  createdAt       DateTime     @default(now())
}

// Track developer earnings per transaction
model DeveloperEarning {
  id              String   @id @default(cuid())
  developerId     String
  developer       Developer @relation(fields: [developerId], references: [id])
  
  transactionId   String
  appId           String
  
  grossAmount     Float
  platformFee     Float
  netAmount       Float
  currency        String
  
  // Payout tracking
  isPaidOut       Boolean  @default(false)
  payoutId        String?
  
  createdAt       DateTime @default(now())
}

// Enums
enum UserRole {
  DEVELOPER
  REVIEWER
  ADMIN
  USER
}

enum AppStatus {
  DRAFT
  IN_REVIEW
  CHANGES_REQUESTED
  APPROVED
  PUBLISHED
  SUSPENDED
  REMOVED
}

enum ReviewStatus {
  PENDING
  IN_PROGRESS
  APPROVED
  REJECTED
  CHANGES_REQUESTED
}

enum Category {
  GAMES
  APPS
  EXPERIENCES
  TOOLS
}


enum ContentRating {
  EVERYONE
  TEEN
  MATURE
  ADULT_ONLY
}

enum ComfortLevel {
  COMFORTABLE
  MODERATE
  INTENSE
}

enum PlayArea {
  SEATED
  STANDING
  ROOMSCALE
}

enum TransactionType {
  PURCHASE
  REFUND
  SUBSCRIPTION
  IN_APP_PURCHASE
}

enum TransactionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PurchaseStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum ReleaseChannelKey {
  ALPHA
  BETA
  RC
  PRODUCTION
}

enum ReleaseStatus {
  ACTIVE
  ROLLED_OUT
  HALTED
  ARCHIVED
}

enum SubmissionStatus {
  PENDING
  IN_REVIEW
  APPROVED
  REJECTED
  CANCELLED
}

enum PayoutStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum PaymentProvider {
  FLUTTERWAVE
  STRIPE
  MPESA_DIRECT
}

enum PayoutMethod {
  BANK_TRANSFER
  MPESA
  MOBILE_MONEY
  STRIPE_CONNECT
  PAYPAL
}

// BLOG / ARTICLES
model Article {
  id            String   @id @default(cuid())
  slug          String   @unique
  title         String
  excerpt       String
  content       String   // Markdown support
  coverImageUrl String
  
  category      String   // 'News', 'Case Study', 'Education', etc.
  tags          Json     @default("[]")
  
  // Author info (simplified for now to avoid User relation complexity if not needed)
  authorName    String
  authorAvatarUrl String?
  
  publishedAt   DateTime @default(now())
  readTime      String   // e.g. "5 min"
  
  views         Int      @default(0)
  likes         Int      @default(0)
  
  featured      Boolean  @default(false)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
